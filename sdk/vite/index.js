var t={};function e(t,e){for(var n=0,r=t.length-1;r>=0;r--){var o=t[r];"."===o?t.splice(r,1):".."===o?(t.splice(r,1),n++):n&&(t.splice(r,1),n--)}if(e)for(;n--;n)t.unshift("..");return t}var n=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,r=function(t){return n.exec(t).slice(1)};function o(){for(var t="",n=!1,r=arguments.length-1;r>=-1&&!n;r--){var o=r>=0?arguments[r]:"/";if("string"!=typeof o)throw new TypeError("Arguments to path.resolve must be strings");o&&(t=o+"/"+t,n="/"===o.charAt(0))}return(n?"/":"")+(t=e(i(t.split("/"),(function(t){return!!t})),!n).join("/"))||"."}function s(t){var n=a(t),r="/"===u(t,-1);return(t=e(i(t.split("/"),(function(t){return!!t})),!n).join("/"))||n||(t="."),t&&r&&(t+="/"),(n?"/":"")+t}function a(t){return"/"===t.charAt(0)}var h={extname:function(t){return r(t)[3]},basename:function(t,e){var n=r(t)[2];return e&&n.substr(-1*e.length)===e&&(n=n.substr(0,n.length-e.length)),n},dirname:function(t){var e=r(t),n=e[0],o=e[1];return n||o?(o&&(o=o.substr(0,o.length-1)),n+o):"."},sep:"/",delimiter:":",relative:function(t,e){function n(t){for(var e=0;e<t.length&&""===t[e];e++);for(var n=t.length-1;n>=0&&""===t[n];n--);return e>n?[]:t.slice(e,n-e+1)}t=o(t).substr(1),e=o(e).substr(1);for(var r=n(t.split("/")),s=n(e.split("/")),a=Math.min(r.length,s.length),h=a,i=0;i<a;i++)if(r[i]!==s[i]){h=i;break}var u=[];for(i=h;i<r.length;i++)u.push("..");return(u=u.concat(s.slice(h))).join("/")},join:function(){return s(i(Array.prototype.slice.call(arguments,0),(function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t})).join("/"))},isAbsolute:a,normalize:s,resolve:o};function i(t,e){if(t.filter)return t.filter(e);for(var n=[],r=0;r<t.length;r++)e(t[r],r,t)&&n.push(t[r]);return n}var u="b"==="ab".substr(-1)?function(t,e,n){return t.substr(e,n)}:function(t,e,n){return e<0&&(e=t.length+e),t.substr(e,n)},l=2147483647,c=/[^\x20-\x7E]/,f=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},m=Math.floor,d=String.fromCharCode;
/*! https://mths.be/punycode v1.4.1 by @mathias */function g(t){throw new RangeError(p[t])}function v(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function y(t,e,n){var r=0;for(t=n?m(t/700):t>>1,t+=m(t/e);t>455;r+=36)t=m(t/35);return m(r+36*t/(t+38))}function b(t){return function(t,e){var n=t.split("@"),r="";n.length>1&&(r=n[0]+"@",t=n[1]);var o=function(t,e){for(var n=t.length,r=[];n--;)r[n]=e(t[n]);return r}((t=t.replace(f,".")).split("."),e).join(".");return r+o}(t,(function(t){return c.test(t)?"xn--"+function(t){var e,n,r,o,s,a,h,i,u,c,f,p,b,j,w,C=[];for(t=function(t){for(var e,n,r=[],o=0,s=t.length;o<s;)(e=t.charCodeAt(o++))>=55296&&e<=56319&&o<s?56320==(64512&(n=t.charCodeAt(o++)))?r.push(((1023&e)<<10)+(1023&n)+65536):(r.push(e),o--):r.push(e);return r}(t),p=t.length,e=128,n=0,s=72,a=0;a<p;++a)(f=t[a])<128&&C.push(d(f));for(r=o=C.length,o&&C.push("-");r<p;){for(h=l,a=0;a<p;++a)(f=t[a])>=e&&f<h&&(h=f);for(h-e>m((l-n)/(b=r+1))&&g("overflow"),n+=(h-e)*b,e=h,a=0;a<p;++a)if((f=t[a])<e&&++n>l&&g("overflow"),f==e){for(i=n,u=36;!(i<(c=u<=s?1:u>=s+26?26:u-s));u+=36)w=i-c,j=36-c,C.push(d(v(c+w%j,0))),i=m(w/j);C.push(d(v(i,0))),s=y(n,b,r==o),n=0,++r}++n,++e}return C.join("")}(t):t}))}function j(t){return null===t}function w(t){return"string"==typeof t}function C(t){return"object"==typeof t&&null!==t}function k(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var O=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function A(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}}function x(t,e){if(t.map)return t.map(e);for(var n=[],r=0;r<t.length;r++)n.push(e(t[r],r));return n}var S=Object.keys||function(t){var e=[];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.push(n);return e};function I(t,e,n,r){e=e||"&",n=n||"=";var o={};if("string"!=typeof t||0===t.length)return o;var s=/\+/g;t=t.split(e);var a=1e3;r&&"number"==typeof r.maxKeys&&(a=r.maxKeys);var h=t.length;a>0&&h>a&&(h=a);for(var i=0;i<h;++i){var u,l,c,f,p=t[i].replace(s,"%20"),m=p.indexOf(n);m>=0?(u=p.substr(0,m),l=p.substr(m+1)):(u=p,l=""),c=decodeURIComponent(u),f=decodeURIComponent(l),k(o,c)?O(o[c])?o[c].push(f):o[c]=[o[c],f]:o[c]=f}return o}function q(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var R=/^([a-z0-9.+-]+:)/i,E=/:[0-9]*$/,F=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,K=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),U=["'"].concat(K),T=["%","/","?",";","#"].concat(U),D=["/","?","#"],$=/^[+a-z0-9A-Z_-]{0,63}$/,N=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,P={javascript:!0,"javascript:":!0},_={javascript:!0,"javascript:":!0},J={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function M(t){var e=t.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var n=t.protocol||"",r=t.pathname||"",o=t.hash||"",s=!1,a="";t.host?s=e+t.host:t.hostname&&(s=e+(-1===t.hostname.indexOf(":")?t.hostname:"["+this.hostname+"]"),t.port&&(s+=":"+t.port)),t.query&&C(t.query)&&Object.keys(t.query).length&&(a=function(t,e,n,r){return e=e||"&",n=n||"=",null===t&&(t=void 0),"object"==typeof t?x(S(t),(function(r){var o=encodeURIComponent(A(r))+n;return O(t[r])?x(t[r],(function(t){return o+encodeURIComponent(A(t))})).join(e):o+encodeURIComponent(A(t[r]))})).join(e):r?encodeURIComponent(A(r))+n+encodeURIComponent(A(t)):""}(t.query));var h=t.search||a&&"?"+a||"";return n&&":"!==n.substr(-1)&&(n+=":"),t.slashes||(!n||J[n])&&!1!==s?(s="//"+(s||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):s||(s=""),o&&"#"!==o.charAt(0)&&(o="#"+o),h&&"?"!==h.charAt(0)&&(h="?"+h),n+s+(r=r.replace(/[?#]/g,(function(t){return encodeURIComponent(t)})))+(h=h.replace("#","%23"))+o}function V(t){var e=t.host,n=E.exec(e);n&&(":"!==(n=n[0])&&(t.port=n.substr(1)),e=e.substr(0,e.length-n.length)),e&&(t.hostname=e)}q.prototype.parse=function(t,e,n){return function(t,e,n,r){if(!w(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var o=e.indexOf("?"),s=-1!==o&&o<e.indexOf("#")?"?":"#",a=e.split(s),h=/\\/g;a[0]=a[0].replace(h,"/"),e=a.join(s);var i=e;if(i=i.trim(),!r&&1===e.split("#").length){var u=F.exec(i);if(u)return t.path=i,t.href=i,t.pathname=u[1],u[2]?(t.search=u[2],t.query=n?I(t.search.substr(1)):t.search.substr(1)):n&&(t.search="",t.query={}),t}var l,c,f,p,m=R.exec(i);if(m){var d=(m=m[0]).toLowerCase();t.protocol=d,i=i.substr(m.length)}if(r||m||i.match(/^\/\/[^@\/]+@[^@\/]+/)){var g="//"===i.substr(0,2);!g||m&&_[m]||(i=i.substr(2),t.slashes=!0)}if(!_[m]&&(g||m&&!J[m])){var v,y,j=-1;for(l=0;l<D.length;l++)-1!==(c=i.indexOf(D[l]))&&(-1===j||c<j)&&(j=c);for(-1!==(y=-1===j?i.lastIndexOf("@"):i.lastIndexOf("@",j))&&(v=i.slice(0,y),i=i.slice(y+1),t.auth=decodeURIComponent(v)),j=-1,l=0;l<T.length;l++)-1!==(c=i.indexOf(T[l]))&&(-1===j||c<j)&&(j=c);-1===j&&(j=i.length),t.host=i.slice(0,j),i=i.slice(j),V(t),t.hostname=t.hostname||"";var C="["===t.hostname[0]&&"]"===t.hostname[t.hostname.length-1];if(!C){var k=t.hostname.split(/\./);for(l=0,f=k.length;l<f;l++){var O=k[l];if(O&&!O.match($)){for(var A="",x=0,S=O.length;x<S;x++)O.charCodeAt(x)>127?A+="x":A+=O[x];if(!A.match($)){var q=k.slice(0,l),E=k.slice(l+1),K=O.match(N);K&&(q.push(K[1]),E.unshift(K[2])),E.length&&(i="/"+E.join(".")+i),t.hostname=q.join(".");break}}}}t.hostname.length>255?t.hostname="":t.hostname=t.hostname.toLowerCase(),C||(t.hostname=b(t.hostname)),p=t.port?":"+t.port:"";var z=t.hostname||"";t.host=z+p,t.href+=t.host,C&&(t.hostname=t.hostname.substr(1,t.hostname.length-2),"/"!==i[0]&&(i="/"+i))}if(!P[d])for(l=0,f=U.length;l<f;l++){var L=U[l];if(-1!==i.indexOf(L)){var W=encodeURIComponent(L);W===L&&(W=escape(L)),i=i.split(L).join(W)}}var X=i.indexOf("#");-1!==X&&(t.hash=i.substr(X),i=i.slice(0,X));var B=i.indexOf("?");-1!==B?(t.search=i.substr(B),t.query=i.substr(B+1),n&&(t.query=I(t.query)),i=i.slice(0,B)):n&&(t.search="",t.query={});i&&(t.pathname=i);J[d]&&t.hostname&&!t.pathname&&(t.pathname="/");if(t.pathname||t.search){p=t.pathname||"";var G=t.search||"";t.path=p+G}return t.href=M(t),t}(this,t,e,n)},q.prototype.format=function(){return M(this)},q.prototype.resolve=function(t){return this.resolveObject(function(t,e,n){if(t&&C(t)&&t instanceof q)return t;var r=new q;return r.parse(t,e,n),r}(t,!1,!0)).format()},q.prototype.resolveObject=function(t){if(w(t)){var e=new q;e.parse(t,!1,!0),t=e}for(var n,r=new q,o=Object.keys(this),s=0;s<o.length;s++){var a=o[s];r[a]=this[a]}if(r.hash=t.hash,""===t.href)return r.href=r.format(),r;if(t.slashes&&!t.protocol){for(var h=Object.keys(t),i=0;i<h.length;i++){var u=h[i];"protocol"!==u&&(r[u]=t[u])}return J[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(t.protocol&&t.protocol!==r.protocol){if(!J[t.protocol]){for(var l=Object.keys(t),c=0;c<l.length;c++){var f=l[c];r[f]=t[f]}return r.href=r.format(),r}if(r.protocol=t.protocol,t.host||_[t.protocol])r.pathname=t.pathname;else{for(n=(t.pathname||"").split("/");n.length&&!(t.host=n.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==n[0]&&n.unshift(""),n.length<2&&n.unshift(""),r.pathname=n.join("/")}if(r.search=t.search,r.query=t.query,r.host=t.host||"",r.auth=t.auth,r.hostname=t.hostname||t.host,r.port=t.port,r.pathname||r.search){var p=r.pathname||"",m=r.search||"";r.path=p+m}return r.slashes=r.slashes||t.slashes,r.href=r.format(),r}var d,g=r.pathname&&"/"===r.pathname.charAt(0),v=t.host||t.pathname&&"/"===t.pathname.charAt(0),y=v||g||r.host&&t.pathname,b=y,C=r.pathname&&r.pathname.split("/")||[],k=r.protocol&&!J[r.protocol];if(n=t.pathname&&t.pathname.split("/")||[],k&&(r.hostname="",r.port=null,r.host&&(""===C[0]?C[0]=r.host:C.unshift(r.host)),r.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===n[0]?n[0]=t.host:n.unshift(t.host)),t.host=null),y=y&&(""===n[0]||""===C[0])),v)r.host=t.host||""===t.host?t.host:r.host,r.hostname=t.hostname||""===t.hostname?t.hostname:r.hostname,r.search=t.search,r.query=t.query,C=n;else if(n.length)C||(C=[]),C.pop(),C=C.concat(n),r.search=t.search,r.query=t.query;else if(null!=t.search)return k&&(r.hostname=r.host=C.shift(),(d=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=d.shift(),r.host=r.hostname=d.shift())),r.search=t.search,r.query=t.query,j(r.pathname)&&j(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r;if(!C.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var O=C.slice(-1)[0],A=(r.host||t.host||C.length>1)&&("."===O||".."===O)||""===O,x=0,S=C.length;S>=0;S--)"."===(O=C[S])?C.splice(S,1):".."===O?(C.splice(S,1),x++):x&&(C.splice(S,1),x--);if(!y&&!b)for(;x--;x)C.unshift("..");!y||""===C[0]||C[0]&&"/"===C[0].charAt(0)||C.unshift(""),A&&"/"!==C.join("/").substr(-1)&&C.push("");var I=""===C[0]||C[0]&&"/"===C[0].charAt(0);return k&&(r.hostname=r.host=I?"":C.length?C.shift():"",(d=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=d.shift(),r.host=r.hostname=d.shift())),(y=y||r.host&&C.length)&&!I&&C.unshift(""),C.length?r.pathname=C.join("/"):(r.pathname=null,r.path=null),j(r.pathname)&&j(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=t.auth||r.auth,r.slashes=r.slashes||t.slashes,r.href=r.format(),r},q.prototype.parseHost=function(){return V(this)};const z=function(t){if("string"==typeof t)t=(new q).parse(t);else if(!(t instanceof q))throw new TypeError('The "path" argument must be of type string or an instance of URL. Received type '+typeof t+String(t));if("file:"!==t.protocol)throw new TypeError("The URL must be of scheme file");return function(t){const e=t.pathname;for(let t=0;t<e.length;t++)if("%"===e[t]){const n=32|e.codePointAt(t+2);if("2"===e[t+1]&&102===n)throw new TypeError("must not include encoded / characters")}return decodeURIComponent(e)}(t)}(import.meta.url),L=h.dirname(z);function W(e){let n;if(e.sdkConfig.appVersion||(e.sdkConfig.appVersion=function(){try{return JSON.parse(t.readFileSync(h.resolve(process.cwd(),"package.json"),"utf-8")).version}catch(t){console.warn("Failed to read version from package.json:",t)}if(process.env.PACKAGE_VERSION)return process.env.PACKAGE_VERSION;return"unknown"}()),fetch(`${e.sdkConfig.url}/createBuild`,{method:"POST",headers:{"Content-Type":"application/json","X-App-Id":e.sdkConfig.appId,"X-App-Key":e.sdkConfig.appKey},body:JSON.stringify({app_version:e.sdkConfig.appVersion})}).then((t=>{t.ok?t.json().then((t=>{e.sdkConfig.buildId=t.build_id})):console.error("Failed to add build to database:",t.status)})),!e.sdkConfig)throw new Error("sdkConfig is required");for(const t in e.sdkConfig)if(!e.sdkConfig[t])throw new Error(`sdkConfig is missing required field: ${t}`);return{name:"vite-plugin-fresk",configResolved(t){n=e.sourcemapDir||t.build.outDir},async buildStart(){const e=h.resolve(L,"../core/index.js"),n=await t.promises.readFile(e,"utf-8");this.emitFile({type:"asset",fileName:"fresk-sdk.js",source:n})},transformIndexHtml:()=>[{tag:"script",attrs:{type:"module"},children:`\n            import('./core/index.js').then(module => {\n              const FreskWebSDK = module.default;\n              \n              const freskSDK = new FreskWebSDK(${JSON.stringify(e.sdkConfig)});\n              freskSDK.init();\n              window.freskSDK = freskSDK;\n            });\n          `}],async writeBundle(){const r=t.readdirSync(n,{withFileTypes:!0}).flatMap((e=>e.isDirectory()?t.readdirSync(h.join(n,e.name)).filter((t=>t.endsWith(".map"))).map((t=>h.join(e.name,t))):e.name.endsWith(".map")?[e.name]:[]));for(const o of r){const r=h.join(n,o),s=t.readFileSync(r,"utf-8"),a={build_id:e.sdkConfig.buildId,file_name:o,map:JSON.parse(s)};fetch(`${e.sdkConfig.url}/addSourceMap`,{method:"POST",headers:{"Content-Type":"application/json","X-App-Id":e.sdkConfig.appId,"X-App-Key":e.sdkConfig.appKey},body:JSON.stringify(a)}).then((t=>{t.ok?t.json().then((t=>{console.log("Source map added to database:",t)})):console.error("Failed to add source map to database:",t.status)}))}if(e.deleteMapsAfterBuild)for(const e of r){const r=h.join(n,e);t.unlinkSync(r),console.log(`Deleted source map: ${r}`)}}}}export{W as default,W as freskPlugin};
